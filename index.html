// ================================
// BACKEND (Node.js + Express)
// Datei: server.js
// ================================

const express = require("express");
const http = require("http");
const { Server } = require("socket.io");
const bcrypt = require("bcrypt");
const sqlite3 = require("sqlite3").verbose();

const app = express();
const server = http.createServer(app);
const io = new Server(server);

app.use(express.json());
app.use(express.static("public"));

// Datenbank
const db = new sqlite3.Database("users.db");

db.run(`CREATE TABLE IF NOT EXISTS users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT UNIQUE,
  password TEXT
)`);

// Registrierung
app.post("/register", async (req, res) => {
  const { username, password } = req.body;
  const hash = await bcrypt.hash(password, 10);

  db.run("INSERT INTO users(username, password) VALUES(?,?)", [username, hash], err => {
    if (err) return res.status(400).send("User existiert bereits");
    res.send("Registriert");
  });
});

// Login
app.post("/login", (req, res) => {
  const { username, password } = req.body;

  db.get("SELECT * FROM users WHERE username=?", [username], async (err, user) => {
    if (!user) return res.status(401).send("Falsche Daten");
    const ok = await bcrypt.compare(password, user.password);
    if (!ok) return res.status(401).send("Falsche Daten");
    res.send("OK");
  });
});

// Voice-Signaling
io.on("connection", socket => {
  socket.on("join", room => {
    socket.join(room);
    socket.to(room).emit("user-joined", socket.id);
  });

  socket.on("signal", data => {
    socket.to(data.room).emit("signal", data);
  });
});

server.listen(3000, () => console.log("Server läuft auf Port 3000"));


// ================================
// FRONTEND
// Ordner: public/
// Dateien: index.html, script.js
// ================================

/* index.html
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Funk System</title>
</head>
<body>
  <h2>Funk wählen</h2>
  <select id="funk">
    <option>Feuerwehr</option>
    <option>Krankenhaus</option>
    <option>Polizei</option>
    <option>Rettungsdienst</option>
    <option>DACE</option>
  </select>
  <p>Push-To-Talk: Taste V gedrückt halten</p>

  <script src="/socket.io/socket.io.js"></script>
  <script src="script.js"></script>
</body>
</html>
*/

/* script.js */
const socket = io();
let localStream;
let peers = {};
let talking = false;

navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
  localStream = stream;
  stream.getAudioTracks()[0].enabled = false;
});

const funk = document.getElementById("funk");

funk.onchange = () => {
  socket.emit("join", funk.value);
};

// Push To Talk mit V
window.addEventListener("keydown", e => {
  if (e.key.toLowerCase() === "v" && !talking) {
    localStream.getAudioTracks()[0].enabled = true;
    talking = true;
  }
});

window.addEventListener("keyup", e => {
  if (e.key.toLowerCase() === "v") {
    localStream.getAudioTracks()[0].enabled = false;
    talking = false;
  }
});
